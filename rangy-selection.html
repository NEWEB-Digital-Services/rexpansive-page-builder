<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Selection</title>
    <style>
    .wrap {
        padding: 50px;
        margin: 0 auto;
    }
    .rangy-toolbar {
        display: flex;
        margin: 10px 0;
    }
    .editor-wrap {
        display: flex;
    }
    .rangy-toolbar-item {
        border: 1px solid #bbb;
        padding: 10px;
    }
    #editor,
    #htmlContent {
        width: 600px;
        height: 600px;
        border: 1px solid #ccc;
        overflow-y: scroll;
    }
    #htmlContent {
        padding: 10px;
    }
    #editor:focus {
        outline: none;
    }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="rangy-toolbar">
            <div class="rangy-toolbar-item">
                <p>TEXT RANGE EXTENSION</p>
                <button id="saveSel">SAVE SELECTION</button>
                <button id="restoreSel">RESTORE SELECTION</button>
                <button id="insert">INSERT</button>
            </div>
            <div class="rangy-toolbar-item">
                <p>SELECTION SAVE AND RESTORE EXTENSION</p>
                <button id="saveSel2">SAVE SELECTION</button>
                <button id="restoreSel2">RESTORE SELECTION</button>
                <button id="insert2">INSERT</button>
            </div>
        </div>
        <div class="editor-wrap">
            <div id="editor" contenteditable="true"><h1>I AM A BEAUTIFUL TITLE</h1><p>Lorem ipsum dolor, <b>sit amet consectetur adipisicing</b> elit. Omnis, officia? Explicabo, aperiam, ipsam alias minima veniam atque et nisi repudiandae <em>dicta eum aspernatur veritatis</em> delectus architecto. </p><p>Doloremque iste perferendis ex.</p><h4>A SMALL TITLE</h4></div>
            <div id="htmlContent"></div>
        </div>
    </div>
    <script src="./public/rangy-1.3.0/rangy-core.js"></script>
    <script src="./public/rangy-1.3.0/rangy-selectionsaverestore.js"></script>
    <script src="./public/rangy-1.3.0/rangy-textrange.js"></script>
    <script src="./public/rangy-1.3.0/rangy-classapplier.js"></script>
    <script stype="text/javascript">
    const editor = document.getElementById("editor");
    const htmlContent = document.getElementById("htmlContent");

    const saveSelBtn = document.getElementById("saveSel");
    const restoreSelBtn = document.getElementById("restoreSel");
    const insertBtn = document.getElementById("insert");

    const saveSelBtn2 = document.getElementById("saveSel2");
    const restoreSelBtn2 = document.getElementById("restoreSel2");
    const insertBtn2 = document.getElementById("insert2");

    let applier;

    window.onload = function() {
       applier = rangy.createClassApplier("zio-pippo");
    }

    const htmlToInsert = "<img src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Polar_Bear_-_Alaska_%28cropped%29.jpg/200px-Polar_Bear_-_Alaska_%28cropped%29.jpg'>";
    const nodeToInsert = document.createElement("img");
    nodeToInsert.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Polar_Bear_-_Alaska_%28cropped%29.jpg/200px-Polar_Bear_-_Alaska_%28cropped%29.jpg";

    function getFirstRange() {
        var sel = rangy.getSelection();
        // simple
        return sel.rangeCount ? sel.getRangeAt(0) : null;
    }

    function getEditorHtml() {
        htmlContent.innerText = editor.innerHTML;
    }

    function wrap(el, wrapper) {
        el.parentNode.insertBefore(wrapper, el);
        wrapper.appendChild(el);
    }

    function emptyLine(node) {
        if( 1 === node.childNodes.length && node.childNodes[0].tagName && "br" === node.childNodes[0].tagName.toLowerCase() ) {
            return true;
        }
        return false;
    }

    getEditorHtml();

    let savedSel = null;
    let savedSel2 = null;

    editor.addEventListener("input", getEditorHtml);

    // TEXT RANGE
    saveSelBtn.addEventListener("click", function(ev) {
        savedSel = rangy.getSelection().saveCharacterRanges(editor);
    });

    restoreSelBtn.addEventListener("click", function(ev) {
        rangy.getSelection().restoreCharacterRanges(editor, savedSel);
        getFirstRange();
    });
    
    insertBtn.addEventListener("click", function(ev) {
        if( savedSel ) {
            rangy.getSelection().restoreCharacterRanges(editor, savedSel);
            let range = getFirstRange();
            if( range ) {
                // range.pasteHtml(htmlToInsert);
                const nodeToInsert = document.createElement("img");
                nodeToInsert.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Polar_Bear_-_Alaska_%28cropped%29.jpg/200px-Polar_Bear_-_Alaska_%28cropped%29.jpg";
                range.insertNode(nodeToInsert);

                if( nodeToInsert.parentElement === editor ) {
                    let prevNode = nodeToInsert.previousSibling;
                    let nextNode = nodeToInsert.nextSibling;
                    let wrapTagName = "";

                    if( nextNode ) {
                        wrapTagName = nextNode.tagName.toLowerCase();
                        if( emptyLine(nextNode) ) {
                            rangy.dom.removeNode(nextNode);
                        }
                    } else if ( prevNode ) {
                        wrapTagName = prevNode.tagName.toLowerCase();
                        if( emptyLine(prevNode) ) {
                            rangy.dom.removeNode(prevNode);
                        }
                    }

                    if( "div" === wrapTagName || "" === wrapTagName ) {
                        wrapTagName = "p";
                    }

                    wrap( nodeToInsert, document.createElement(wrapTagName) );
                }
            }
        }
        getEditorHtml();
    });

    // SAVE AND RESTORE SELECTION
    saveSelBtn2.addEventListener("click", function(ev) {
        savedSel2 = rangy.saveSelection();
    });

    restoreSelBtn2.addEventListener("click", function(ev) {
        rangy.restoreSelection(savedSel2);
    });

    insertBtn2.addEventListener("click", function(ev) {
        if( savedSel2 ) {
            console.log(savedSel2);
            rangy.restoreSelection(savedSel2);
            let range = getFirstRange();
            range.insertNode(nodeToInsert);
        }
        getEditorHtml();
    });
    </script>
</body>
</html>